name: Release

on:
  workflow_dispatch:
    inputs:
      level:
        description: "Release level"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
          - os: macos-14
          - os: windows-2022
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run Tests
        run: cargo test
      - name: Running clippy
        run: cargo clippy --all-targets --all-features -p tango-bench --message-format=json | cargo-action-fmt

  lint:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Checking formatting
        run: cargo fmt -- --check --color always
      - name: Typos
        uses: crate-ci/typos@master

  release:
    needs: [test, lint]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-release
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-release

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run cargo release
        run: cargo release -p tango-bench --no-confirm --no-publish --execute ${{ inputs.level }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Push changes
        run: git push

      - name: Get released version
        id: version
        run: |
          VERSION=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[] | select(.name == "tango-bench") | .version')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --generate-notes
